<%*const topic = await tp.system.prompt("ðŸ“˜ Please enter a Topic!")
if (!topic || topic.trim() === "") {
	new Notice("âŒ Topicì„ ìž…ë ¥í•˜ì§€ ì•Šì•„ ì¤‘ë‹¨ë©ë‹ˆë‹¤.");
	return;
}

const folder = tp.file.folder(true)
const parts = folder.split("/")
const count = parts.length

const curDirPath = `${folder}/${topic}`
const curFileName = `_MOC_`
const curFilePath = `${curDirPath}/${curFileName}`
await app.vault.createFolder(`${curDirPath}`).catch(() => {})

let templatefile = await tp.file.find_tfile("AB. Template-Note-MOC");
if (!templatefile) {
	console.log("âŒ Template-MOC íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	return;
}
const templateContent = await app.vault.read(templatefile);
console.log(`Template Content: ${templateContent}`);
await tp.file.create_new(templatefile, curFileName, true, curDirPath);
%>
<%*
const mocDirPath = curDirPath.split("/").slice(0, -1).join("/");
const mocFileName = `_MOC_`;
const mocFilePath = `${mocDirPath}/${mocFileName}`;
console.log(`[[${mocFilePath}|${topic}]]`);

let mocFile = await app.vault.getAbstractFileByPath(mocFilePath + ".md");
if (!mocFile) {
	console.log(`Create: ${mocFilePath}`);
	mocFile = await app.vault.create(mocFilePath + ".md", templateContent);
} else {
	console.log(`Find: ${mocFilePath}`);
}

let yamlLink = `  - "[[${curFilePath}|${topic}]]"`;
const original = await app.vault.read(mocFile);
if (!original.includes(yamlLink)) {
	const updated = original.replace(/Outgoinglinks:\s*\n/, match => `${match}${yamlLink}\n`);
	await app.vault.modify(mocFile, updated);
	console.log(`âœ… ë§í¬ ì¶”ê°€ë¨: ${yamlLink}`);
} else {
	console.log(`ðŸ” ì´ë¯¸ ì¡´ìž¬í•¨: ${yamlLink}`);
}
%>
<%*
yamlBacklink = `  - "[[${mocFilePath}|${parts[parts.length - 1]}]]"`;
let curFile = await app.vault.getAbstractFileByPath(curFilePath + ".md");
if (!curFile) {
	console.log(`âŒ ${curFilePath} íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
	return;
}

let curContent = await app.vault.read(curFile);
if (!curContent.includes(yamlBacklink)) {
	if (curContent.match(/Backlinks:\s*\n/)) {
		const updated = curContent.replace(/Backlinks:\s*\n/, match => `${match}${yamlBacklink}\n`);
		await app.vault.modify(curFile, updated);
		console.log(`ðŸ”— Backlinks ì¶”ê°€ë¨: ${yamlBacklink}`);
	} else {
		console.log("âŒ Backlinks í•­ëª© ì—†ìŒ");
	}
} else {
	console.log(`ðŸ” Backlinks ì´ë¯¸ ì¡´ìž¬í•¨`);
}
%>
<%* await tp.file.move(`.trash/${tp.file.title}`); %>
